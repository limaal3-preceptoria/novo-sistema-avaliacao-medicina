"""Evaluation blueprint and API endpoints for the application.\n"""\n\nfrom datetime import datetime\nfrom flask import Blueprint, request, jsonify  # pylint: disable=import-error\nfrom src.models.evaluation import (\n    db,\n    HealthUnit,\n    Preceptor,\n    Student,\n    StudentGroup,\n    GroupMembership,\n    EvaluationDate,\n    Evaluation,\n)  # pylint: disable=import-error\n\nevaluation_bp = Blueprint('evaluation', __name__)\n\n\n@evaluation_bp.after_request\ndef after_request(response):\n    """Add CORS headers to all responses."""\n    response.headers.add('Access-Control-Allow-Origin', '*')\n    response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')\n    response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')\n    return response\n\n\n@evaluation_bp.route('/health-units', methods=['GET', 'POST'])\ndef health_units():\n    """List or create health units."""\n    if request.method == 'GET':\n        units = HealthUnit.query.all()\n        return jsonify([unit.to_dict() for unit in units])\n\n    data = request.get_json()\n    unit = HealthUnit(name=data['name'])\n    db.session.add(unit)\n    db.session.commit()\n    return jsonify(unit.to_dict()), 201\n\n\n@evaluation_bp.route('/preceptors', methods=['GET', 'POST'])\ndef preceptors():\n    """List or create preceptors."""\n    if request.method == 'GET':\n        preceptors_list = Preceptor.query.all()\n        return jsonify([preceptor.to_dict() for preceptor in preceptors_list])\n\n    data = request.get_json()\n    preceptor = Preceptor(\n        name=data['name'],\n        email=data.get('email')\n    )\n    db.session.add(preceptor)\n    db.session.commit()\n    return jsonify(preceptor.to_dict()), 201\n\n\n@evaluation_bp.route('/students', methods=['GET', 'POST'])\ndef students():\n    """List or create students."""\n    if request.method == 'GET':\n        students_list = Student.query.all()\n        return jsonify([student.to_dict() for student in students_list])\n\n    data = request.get_json()\n    student = Student(\n        name=data['name'],\n        registration=data.get('registration')\n    )\n    db.session.add(student)\n    db.session.commit()\n    return jsonify(student.to_dict()), 201\n\n\n@evaluation_bp.route('/groups', methods=['GET', 'POST'])\ndef groups():\n    """List or create student groups."""\n    if request.method == 'GET':\n        groups_list = StudentGroup.query.all()\n        return jsonify([group.to_dict() for group in groups_list])\n\n    data = request.get_json()\n    group = StudentGroup(\n        name=data['name'],\n        period=data['period'],\n        year=data['year'],\n        semester=data['semester'],\n        health_unit_id=data['health_unit_id'],\n        preceptor_id=data['preceptor_id']\n    )\n    db.session.add(group)\n    db.session.commit()\n    return jsonify(group.to_dict()), 201\n\n\n@evaluation_bp.route('/groups/<int:group_id>/students', methods=['GET', 'POST'])\ndef group_students(group_id):\n    """List or add students to a group."""\n    if request.method == 'GET':\n        memberships = GroupMembership.query.filter_by(group_id=group_id).all()\n        return jsonify([membership.to_dict() for membership in memberships])\n\n    data = request.get_json()\n    membership = GroupMembership(\n        student_id=data['student_id'],\n        group_id=group_id\n    )\n    db.session.add(membership)\n    db.session.commit()\n    return jsonify(membership.to_dict()), 201\n\n\n@evaluation_bp.route('/groups/<int:group_id>/evaluation-dates', methods=['GET', 'POST'])\ndef evaluation_dates(group_id):\n    """List or create evaluation dates for a group."""\n    if request.method == 'GET':\n        dates = EvaluationDate.query.filter_by(group_id=group_id).all()\n        return jsonify([d.to_dict() for d in dates])\n\n    data = request.get_json()\n    eval_date = EvaluationDate(\n        group_id=group_id,\n        date=datetime.strptime(data['date'], '%Y-%m-%d').date(),\n        description=data.get('description')\n    )\n    db.session.add(eval_date)\n    db.session.commit()\n    return jsonify(eval_date.to_dict()), 201\n\n\n@evaluation_bp.route('/evaluations', methods=['GET', 'POST'])\ndef evaluations():\n    """List or create evaluations."""\n    if request.method == 'GET':\n        student_id = request.args.get('student_id')\n        group_id = request.args.get('group_id')\n\n        query = Evaluation.query\n\n        if student_id:\n            query = query.filter_by(student_id=student_id)\n\n        if group_id:\n            query = query.join(EvaluationDate).filter(EvaluationDate.group_id == group_id)\n\n        evaluations_list = query.all()\n        return jsonify([evaluation.to_dict() for evaluation in evaluations_list])\n\n    data = request.get_json()\n    evaluation = Evaluation(\n        student_id=data['student_id'],\n        evaluation_date_id=data['evaluation_date_id'],\n        attitude_score=data.get('attitude_score'),\n        skill_score=data.get('skill_score'),\n        cognition_score=data.get('cognition_score'),\n        observations=data.get('observations')\n    )\n    db.session.add(evaluation)\n    db.session.commit()\n    return jsonify(evaluation.to_dict()), 201\n\n\n@evaluation_bp.route('/evaluations/<int:evaluation_id>', methods=['PUT', 'DELETE'])\ndef evaluation_detail(evaluation_id):\n    """Update or delete a specific evaluation."""\n    evaluation = Evaluation.query.get_or_404(evaluation_id)\n\n    if request.method == 'PUT':\n        data = request.get_json()\n        evaluation.attitude_score = data.get('attitude_score', evaluation.attitude_score)\n        evaluation.skill_score = data.get('skill_score', evaluation.skill_score)\n        evaluation.cognition_score = data.get('cognition_score', evaluation.cognition_score)\n        evaluation.observations = data.get('observations', evaluation.observations)\n        evaluation.updated_at = datetime.utcnow()\n\n        db.session.commit()\n        return jsonify(evaluation.to_dict())\n\n    db.session.delete(evaluation)\n    db.session.commit()\n    return '', 204\n\n\n@evaluation_bp.route('/groups/<int:group_id>/report', methods=['GET'])\ndef group_report(group_id):\n    """Generate a full report for a group."""\n    group = StudentGroup.query.get_or_404(group_id)\n\n    # Fetch members and related data\n    memberships = GroupMembership.query.filter_by(group_id=group_id).all()\n    group_members = [membership.student for membership in memberships]\n\n    eval_dates = EvaluationDate.query.filter_by(group_id=group_id).order_by(EvaluationDate.date).all()\n\n    group_evaluations = (\n        Evaluation.query.join(EvaluationDate).filter(EvaluationDate.group_id == group_id).all()\n    )\n\n    report_data = {\n        'group': group.to_dict(),\n        'students': [],\n        'evaluation_dates': [d.to_dict() for d in eval_dates]\n    }\n\n    for student in group_members:\n        student_data = student.to_dict()\n        student_evaluations = [ev for ev in group_evaluations if ev.student_id == student.id]\n\n        evaluations_by_date = {}\n        for evaluation in student_evaluations:\n            date_id = evaluation.evaluation_date_id\n            evaluations_by_date[date_id] = evaluation.to_dict()\n\n        student_data['evaluations'] = evaluations_by_date\n\n        attitude_scores = [ev.attitude_score for ev in student_evaluations if ev.attitude_score is not None]\n        skill_scores = [ev.skill_score for ev in student_evaluations if ev.skill_score is not None]\n        cognition_scores = [ev.cognition_score for ev in student_evaluations if ev.cognition_score is not None]\n\n        student_data['averages'] = {\n            'attitude': sum(attitude_scores) / len(attitude_scores) if attitude_scores else None,\n            'skill': sum(skill_scores) / len(skill_scores) if skill_scores else None,\n            'cognition': sum(cognition_scores) / len(cognition_scores) if cognition_scores else None,\n        }\n\n        all_scores = attitude_scores + skill_scores + cognition_scores\n        student_data['overall_average'] = sum(all_scores) / len(all_scores) if all_scores else None\n\n        report_data['students'].append(student_data)\n\n    return jsonify(report_data)\n\n\n@evaluation_bp.route('/import-spreadsheet', methods=['POST'])\ndef import_spreadsheet():\n    """Import example data from a spreadsheet into the database.\n\n    Note: this helper endpoint is intended for initial data population in development.\n    """\n    # pylint: disable=too-many-locals\n    try:\n        # Create health unit\n        health_unit = HealthUnit(name=\"UNIDADE DE SAÚDE DA FAMÍLIA DO BOM TEMPO\")\n        db.session.add(health_unit)\n        db.session.flush()\n\n        # Create preceptor\n        preceptor = Preceptor(name=\"DR Renê Carvalho de Brito\")\n        db.session.add(preceptor)\n        db.session.flush()\n\n        # Create group\n        group = StudentGroup(\n            name=\"8ª ETAPA DO PIESF (Terças-feiras)\",\n            period=\"8ª ETAPA\",\n            year=2025,\n            semester=1,\n            health_unit_id=health_unit.id,\n            preceptor_id=preceptor.id,\n        )\n        db.session.add(group)\n        db.session.flush()\n\n        # Create students\n        students_data = [\n            {\"name\": \"ISABELA PEREIRA\"},\n            {\"name\": \"INGRID MACEDO\"},\n        ]\n\n        created_students = []\n        for student_data in students_data:\n            student = Student(name=student_data[\"name\"])\n            db.session.add(student)\n            db.session.flush()\n            created_students.append(student)\n\n            membership = GroupMembership(student_id=student.id, group_id=group.id)\n            db.session.add(membership)\n\n        # Create evaluation dates\n        evaluation_dates_data = [\n            \"2025-02-11\", \"2025-02-25\", \"2025-03-18\", \"2025-04-01\",\n            \"2025-04-15\", \"2025-04-29\", \"2025-05-13\", \"2025-05-27\", \"2025-06-10\",\n        ]\n\n        eval_dates = []\n        for date_str in evaluation_dates_data:\n            eval_date = EvaluationDate(\n                group_id=group.id,\n                date=datetime.strptime(date_str, '%Y-%m-%d').date(),\n            )\n            db.session.add(eval_date)\n            db.session.flush()\n            eval_dates.append(eval_date)\n\n        # Example evaluations (Isabela)\n        isabela_scores = [\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 7, \"skill\": 7, \"cognition\": 7},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 7, \"skill\": 7, \"cognition\": 7},\n        ]\n\n        for i, scores in enumerate(isabela_scores):\n            evaluation = Evaluation(\n                student_id=created_students[0].id,\n                evaluation_date_id=eval_dates[i].id,\n                attitude_score=scores[\"attitude\"],\n                skill_score=scores[\"skill\"],\n                cognition_score=scores[\"cognition\"],\n            )\n            db.session.add(evaluation)\n\n        # Example evaluations (Ingrid)\n        ingrid_scores = [\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 10, \"skill\": 10, \"cognition\": 10},\n            {\"attitude\": 7, \"skill\": 7, \"cognition\": 7},\n        ]\n\n        for i, scores in enumerate(ingrid_scores):\n            evaluation = Evaluation(\n                student_id=created_students[1].id,\n                evaluation_date_id=eval_dates[i].id,\n                attitude_score=scores[\"attitude\"],\n                skill_score=scores[\"skill\"],\n                cognition_score=scores[\"cognition\"],\n            )\n            db.session.add(evaluation)\n\n        db.session.commit()\n\n        return jsonify({\n            \"message\": \"Dados importados com sucesso!\",\n            \"group_id\": group.id,\n        }), 201\n\n    except Exception as e:  # pylint: disable=broad-except\n        db.session.rollback()\n        return jsonify({\"error\": str(e)}), 500\n